<!DOCTYPE html>
<html>
  <head>
    <title>Chatbot</title>
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">

      function ChatInput({ chatMessages, setChatMessages, state, updateIsLoading }) {
        const [ inputText, setInputText ] = React.useState("");

        function saveInputText(event) {
          setInputText(event.target.value);
        }

        async function sendMessage() {
          if (inputText === "") return
          
          const newChatMessages = [
            ...chatMessages,
            {
              id: crypto.randomUUID(),
              message: inputText,
              sender: "user"
            }
          ]

          setChatMessages(newChatMessages);
          setInputText("");

          setChatMessages([
            ...newChatMessages,
            {
              id: crypto.randomUUID(),
              message: "Loading...",
              sender: "robot"
            }
          ])

          updateIsLoading(true)
          const response = await Chatbot.getResponseAsync(inputText);
          updateIsLoading(false)
          
          setChatMessages([
            ...newChatMessages,
            {
              id: crypto.randomUUID(),
              message: response,
              sender: "robot"
            }
          ]);
        }

        function checkKeyDown(event) {
          console.log(event.key)
          event.key === 'Enter' ? sendMessage() : null
          event.key === 'Escape' ? setInputText("") : null
        }

        return (
          <>
            <input 
              placeholder="Type something" 
              size="30"
              onChange={ saveInputText }
              onKeyDown={ checkKeyDown }
              value={ inputText }
              disabled={ state }
            />
            <button
              onClick={ sendMessage }
            >Send</button>
          </>
        );
      };

      function ChatMessage({ message, sender }) {

        return (
          <div>
            { sender === 'robot' && (
              <img 
                src="robot.png" 
                width="50"
              />
            )}
            { message }
            { sender === 'user' && (
              <img 
                src="user.png" 
                width="50"
              />
            ) }
          </div>
        );
      };

      function ChatMessages({ chatMessages }) {
        return (
          <>
            { chatMessages.map((chatMessage) => {
              return (
                <ChatMessage
                  key={ chatMessage.id }
                  message={ chatMessage.message }
                  sender={ chatMessage.sender }
                />
              );
            })}
          </>
        )
      };

      function App() {
        const [ isLoading, updateIsLoading ] = React.useState(false);
        const [ chatMessages, setChatMessages ] = React.useState([{
          id: 'id1',
          message: 'Hello there',
          sender: 'user'
        }, {
          id: 'id2',
          message: 'Waddup',
          sender: 'robot'
        }]);
        //const [ chatMessages, setChatMessages ] = array; 
        // const chatMessages = array[0];
        // const setChatMessages = array[1];

        return (
          <>
            <ChatInput 
              chatMessages={ chatMessages }
              setChatMessages={ setChatMessages }
              updateIsLoading={ updateIsLoading }
              state={ isLoading }
            />
            <ChatMessages 
              chatMessages={ chatMessages }
              setChatMessages={ setChatMessages }
            />
          </>
        );
      };

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>
